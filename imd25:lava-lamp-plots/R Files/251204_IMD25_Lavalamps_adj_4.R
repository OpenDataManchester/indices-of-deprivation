#install.packages("tidyverse")
#install.packages("readxl")
library(tidyverse)
library(readxl)

#### ONS Official Rankings ####

ons_rankings <- tribble(
  ~la_code, ~la_name, ~ons_rank,
  "E06000009", "Blackpool", 1,
  "E08000003", "Manchester", 2,
  "E07000062", "Hastings", 3,
  "E07000117", "Burnley", 4,
  "E08000028", "Sandwell", 5,
  "E06000016", "Leicester", 6,
  "E09000025", "Newham", 7,
  "E08000025", "Birmingham", 8,
  "E09000002", "Barking and Dagenham", 9,
  "E09000012", "Hackney", 10,
  "E06000008", "Blackburn with Darwen", 11,
  "E08000012", "Liverpool", 12,
  "E07000122", "Pendle", 13,
  "E06000010", "Kingston upon Hull, City of", 14,
  "E08000004", "Oldham", 15,
  "E07000120", "Hyndburn", 16,
  "E08000011", "Knowsley", 17,
  "E06000018", "Nottingham", 18,
  "E08000005", "Rochdale", 19,
  "E09000030", "Tower Hamlets", 20,
  "E06000002", "Middlesbrough", 21,
  "E09000005", "Brent", 22,
  "E08000032", "Bradford", 23,
  "E08000031", "Wolverhampton", 24,
  "E07000145", "Great Yarmouth", 25,
  "E06000021", "Stoke-on-Trent", 26,
  "E07000137", "East Lindsey", 27,
  "E07000076", "Tendring", 28,
  "E09000014", "Haringey", 29,
  "E06000001", "Hartlepool", 30,
  "E08000024", "Sunderland", 31,
  "E07000114", "Thanet", 32,
  "E06000032", "Luton", 33,
  "E08000006", "Salford", 34,
  "E08000023", "South Tyneside", 35,
  "E07000136", "Boston", 36,
  "E09000010", "Enfield", 37,
  "E08000030", "Walsall", 38,
  "E09000019", "Islington", 39,
  "E08000016", "Barnsley", 40,
  "E08000008", "Tameside", 41,
  "E07000010", "Fenland", 42,
  "E08000001", "Bolton", 43,
  "E08000017", "Doncaster", 44,
  "E09000009", "Ealing", 45,
  "E09000023", "Lewisham", 46,
  "E06000047", "County Durham", 47,
  "E07000138", "Lincoln", 48,
  "E09000018", "Hounslow", 49,
  "E06000027", "Torbay", 50,
  "E06000031", "Peterborough", 51,
  "E07000033", "Bolsover", 52,
  "E08000018", "Rotherham", 53,
  "E07000046", "Torridge", 54,
  "E06000006", "Halton", 55,
  "E06000046", "Isle of Wight", 56,
  "E07000123", "Preston", 57,
  "E08000037", "Gateshead", 58,
  "E07000113", "Swale", 59,
  "E07000125", "Rossendale", 60,
  "E08000026", "Coventry", 61,
  "E06000003", "Redcar and Cleveland", 62,
  "E08000036", "Wakefield", 63,
  "E07000148", "Norwich", 64,
  "E09000031", "Waltham Forest", 65,
  "E07000112", "Folkestone and Hythe", 66,
  "E09000028", "Southwark", 67,
  "E08000013", "St. Helens", 68,
  "E07000146", "King's Lynn and West Norfolk", 69,
  "E09000022", "Lambeth", 70,
  "E08000033", "Calderdale", 71,
  "E06000039", "Slough", 72,
  "E06000044", "Portsmouth", 73,
  "E09000011", "Greenwich", 74,
  "E07000170", "Ashfield", 75,
  "E06000045", "Southampton", 76,
  "E07000174", "Mansfield", 77,
  "E07000108", "Dover", 78,
  "E06000015", "Derby", 79,
  "E07000034", "Chesterfield", 80,
  "E06000012", "North East Lincolnshire", 81,
  "E08000021", "Newcastle upon Tyne", 82,
  "E09000007", "Camden", 83,
  "E07000202", "Ipswich", 84,
  "E08000034", "Kirklees", 85,
  "E06000052", "Cornwall", 86,
  "E09000033", "Westminster", 87,
  "E07000219", "Nuneaton and Bedworth", 88,
  "E07000147", "North Norfolk", 89,
  "E08000019", "Sheffield", 90,
  "E06000035", "Medway", 91,
  "E07000073", "Harlow", 92,
  "E07000064", "Rother", 93,
  "E07000109", "Gravesham", 94,
  "E06000020", "Telford and Wrekin", 95,
  "E07000061", "Eastbourne", 96,
  "E07000088", "Gosport", 97,
  "E06000063", "Cumberland", 98,
  "E07000043", "North Devon", 99,
  "E07000140", "South Holland", 100,
  "E06000026", "Plymouth", 101,
  "E08000010", "Wigan", 102,
  "E06000005", "Darlington", 103,
  "E06000013", "North Lincolnshire", 104,
  "E09000008", "Croydon", 105,
  "E08000015", "Wirral", 106,
  "E08000002", "Bury", 107,
  "E09000013", "Hammersmith and Fulham", 108,
  "E07000226", "Crawley", 109,
  "E08000014", "Sefton", 110,
  "E07000171", "Bassetlaw", 111,
  "E07000143", "Breckland", 112,
  "E06000033", "Southend-on-Sea", 113,
  "E06000034", "Thurrock", 114,
  "E08000027", "Dudley", 115,
  "E09000017", "Hillingdon", 116,
  "E07000047", "West Devon", 117,
  "E07000239", "Wyre Forest", 118,
  "E06000004", "Stockton-on-Tees", 119,
  "E07000066", "Basildon", 120,
  "E07000080", "Forest of Dean", 121,
  "E07000218", "North Warwickshire", 122,
  "E06000023", "Bristol, City of", 123,
  "E08000035", "Leeds", 124,
  "E07000243", "Stevenage", 125,
  "E07000042", "Mid Devon", 126,
  "E09000026", "Redbridge", 127,
  "E06000057", "Northumberland", 128,
  "E09000003", "Barnet", 129,
  "E09000020", "Kensington and Chelsea", 130,
  "E07000142", "West Lindsey", 131,
  "E07000192", "Cannock Chase", 132,
  "E07000105", "Ashford", 133,
  "E06000066", "Somerset", 134,
  "E07000121", "Lancaster", 135,
  "E06000019", "Herefordshire, County of", 136,
  "E07000224", "Arun", 137,
  "E07000244", "East Suffolk", 138,
  "E07000090", "Havant", 139,
  "E07000199", "Tamworth", 140,
  "E06000055", "Bedford", 141,
  "E07000081", "Gloucester", 142,
  "E06000043", "Brighton and Hove", 143,
  "E07000036", "Erewash", 144,
  "E08000022", "North Tyneside", 145,
  "E07000195", "Newcastle-under-Lyme", 146,
  "E06000038", "Reading", 147,
  "E07000236", "Redditch", 148,
  "E07000106", "Canterbury", 149,
  "E07000128", "Wyre", 150,
  "E07000175", "Newark and Sherwood", 151,
  "E07000095", "Broxbourne", 152,
  "E09000015", "Harrow", 153,
  "E06000051", "Shropshire", 154,
  "E07000110", "Maidstone", 155,
  "E07000193", "East Staffordshire", 156,
  "E06000042", "Milton Keynes", 157,
  "E07000038", "North East Derbyshire", 158,
  "E07000045", "Teignbridge", 159,
  "E06000061", "North Northamptonshire", 160,
  "E07000032", "Amber Valley", 161,
  "E07000069", "Castle Point", 162,
  "E07000107", "Dartford", 163,
  "E07000067", "Braintree", 164,
  "E06000064", "Westmorland and Furness", 165,
  "E07000237", "Worcester", 166,
  "E07000037", "High Peak", 167,
  "E07000071", "Colchester", 168,
  "E06000058", "Bournemouth, Christchurch and Poole", 169,
  "E07000063", "Lewes", 170,
  "E07000074", "Maldon", 171,
  "E07000245", "West Suffolk", 172,
  "E09000016", "Havering", 173,
  "E06000059", "Dorset", 174,
  "E07000103", "Watford", 175,
  "E07000127", "West Lancashire", 176,
  "E07000225", "Chichester", 177,
  "E07000238", "Wychavon", 178,
  "E07000235", "Malvern Hills", 179,
  "E06000030", "Swindon", 180,
  "E07000044", "South Hams", 181,
  "E06000062", "West Northamptonshire", 182,
  "E08000007", "Stockport", 183,
  "E07000200", "Babergh", 184,
  "E07000229", "Worthing", 185,
  "E06000050", "Cheshire West and Chester", 186,
  "E07000041", "Exeter", 187,
  "E07000119", "Fylde", 188,
  "E06000065", "North Yorkshire", 189,
  "E07000118", "Chorley", 190,
  "E07000203", "Mid Suffolk", 191,
  "E07000223", "Adur", 192,
  "E09000032", "Wandsworth", 193,
  "E07000134", "North West Leicestershire", 194,
  "E07000040", "East Devon", 195,
  "E07000213", "Spelthorne", 196,
  "E07000092", "Rushmoor", 197,
  "E07000133", "Melton", 198,
  "E06000007", "Warrington", 199,
  "E09000004", "Bexley", 200,
  "E07000141", "South Kesteven", 201,
  "E07000198", "Staffordshire Moorlands", 202,
  "E06000011", "East Riding of Yorkshire", 203,
  "E08000029", "Solihull", 204,
  "E07000072", "Epping Forest", 205,
  "E07000111", "Sevenoaks", 206,
  "E09000024", "Merton", 207,
  "E07000241", "Welwyn Hatfield", 208,
  "E07000173", "Gedling", 209,
  "E07000039", "South Derbyshire", 210,
  "E07000096", "Dacorum", 211,
  "E07000116", "Tunbridge Wells", 212,
  "E07000035", "Derbyshire Dales", 213,
  "E07000098", "Hertsmere", 214,
  "E06000024", "North Somerset", 215,
  "E07000220", "Rugby", 216,
  "E07000178", "Oxford", 217,
  "E07000132", "Hinckley and Bosworth", 218,
  "E06000054", "Wiltshire", 219,
  "E07000149", "South Norfolk", 220,
  "E06000053", "Isles of Scilly", 221,
  "E07000196", "South Staffordshire", 222,
  "E08000009", "Trafford", 223,
  "E09000029", "Sutton", 224,
  "E07000197", "Stafford", 225,
  "E07000139", "North Kesteven", 226,
  "E07000126", "South Ribble", 227,
  "E07000172", "Broxtowe", 228,
  "E07000135", "Oadby and Wigston", 229,
  "E06000056", "Central Bedfordshire", 230,
  "E06000049", "Cheshire East", 231,
  "E07000130", "Charnwood", 232,
  "E07000070", "Chelmsford", 233,
  "E07000082", "Stroud", 234,
  "E07000115", "Tonbridge and Malling", 235,
  "E07000215", "Tandridge", 236,
  "E07000084", "Basingstoke and Deane", 237,
  "E07000065", "Wealden", 238,
  "E07000091", "New Forest", 239,
  "E07000144", "Broadland", 240,
  "E07000194", "Lichfield", 241,
  "E07000009", "East Cambridgeshire", 242,
  "E07000079", "Cotswold", 243,
  "E07000177", "Cherwell", 244,
  "E07000212", "Runnymede", 245,
  "E07000221", "Stratford-on-Avon", 246,
  "E07000093", "Test Valley", 247,
  "E09000006", "Bromley", 248,
  "E07000011", "Huntingdonshire", 249,
  "E06000060", "Buckinghamshire", 250,
  "E07000078", "Cheltenham", 251,
  "E06000022", "Bath and North East Somerset", 252,
  "E06000025", "South Gloucestershire", 253,
  "E07000083", "Tewkesbury", 254,
  "E07000008", "Cambridge", 255,
  "E07000099", "North Hertfordshire", 256,
  "E06000037", "West Berkshire", 257,
  "E07000217", "Woking", 258,
  "E09000021", "Kingston upon Thames", 259,
  "E07000075", "Rochford", 260,
  "E06000014", "York", 261,
  "E07000068", "Brentwood", 262,
  "E07000086", "Eastleigh", 263,
  "E07000222", "Warwick", 264,
  "E07000129", "Blaby", 265,
  "E07000234", "Bromsgrove", 266,
  "E09000001", "City of London", 267,
  "E07000094", "Winchester", 268,
  "E07000077", "Uttlesford", 269,
  "E07000181", "West Oxfordshire", 270,
  "E06000036", "Bracknell Forest", 271,
  "E06000017", "Rutland", 272,
  "E07000124", "Ribble Valley", 273,
  "E07000211", "Reigate and Banstead", 274,
  "E07000102", "Three Rivers", 275,
  "E07000242", "East Hertfordshire", 276,
  "E07000210", "Mole Valley", 277,
  "E07000085", "East Hampshire", 278,
  "E07000227", "Horsham", 279,
  "E07000180", "Vale of White Horse", 280,
  "E07000012", "South Cambridgeshire", 281,
  "E09000027", "Richmond upon Thames", 282,
  "E07000131", "Harborough", 283,
  "E07000209", "Guildford", 284,
  "E06000040", "Windsor and Maidenhead", 285,
  "E07000228", "Mid Sussex", 286,
  "E07000179", "South Oxfordshire", 287,
  "E07000240", "St Albans", 288,
  "E07000216", "Waverley", 289,
  "E07000214", "Surrey Heath", 290,
  "E07000087", "Fareham", 291,
  "E07000207", "Elmbridge", 292,
  "E07000208", "Epsom and Ewell", 293,
  "E07000176", "Rushcliffe", 294,
  "E06000041", "Wokingham", 295,
  "E07000089", "Hart", 296,
)

#### Get the IMD 2025 data ####

### IMD 2025 data at LSOA level from Excel file
imd_data_lsoa <- read_excel("~/Desktop/Lavalamps 2025/File_1_IoD2025_Index_of_Multiple_Deprivation.xlsx", 
                             sheet = "IMD25")

#### Process the IMD 2025 data ####

# Create global vigintiles based on all England LSOAs ranked by IMD
imd_data_processed <- imd_data_lsoa %>%
  rename(
    lsoa_code = 'LSOA code (2021)',
    lsoa_name = 'LSOA name (2021)',
    la_code = 'Local Authority District code (2024)',
    la_name = 'Local Authority District name (2024)',
    imd_rank = 'Index of Multiple Deprivation (IMD) Rank (where 1 is most deprived)'
  ) %>%
  # Filter to England only (LSOA codes starting with E01)
  filter(substr(lsoa_code, 1, 3) == 'E01') %>%
  # Create global vigintiles: divide all England LSOAs into 20 equal groups by IMD rank
  mutate(vigintile = ntile(imd_rank, 20))

# Count LSOAs in each vigintile for each local authority
imd_data_lsoa_la <- imd_data_processed %>%
  group_by(la_code, la_name, vigintile) %>%
  summarise(count = n(), .groups = 'drop') %>%
  # Join with official ONS rankings
  left_join(ons_rankings, by = c('la_code', 'la_name')) %>%
  select('la_code', 'la_name', 'vigintile', 'count', 'ons_rank')

#### Prepare the chart ####

## Add the sort factor to allow sorting by ONS rank

imd_data_lsoa_la$la_name_IMD <- reorder(imd_data_lsoa_la$la_name, imd_data_lsoa_la$ons_rank)

## Calculate normalised counts for each LA (for reference in CSV)
imd_data_with_normalised <- imd_data_lsoa_la %>%
  group_by(la_code, la_name) %>%
  mutate(max_count = max(count),
         normalised_count = count / max_count) %>%
  ungroup() %>%
  arrange(ons_rank, vigintile) %>%
  select(la_name, vigintile, count, normalised_count, ons_rank)

## Export to CSV
write_csv(imd_data_with_normalised, "~/Desktop/Lavalamps 2025/deprivation_vigintile_counts_2025.csv")

## Make the lava lamp plot

eng_imd_lava <- ggplot(imd_data_lsoa_la, aes(la_name_IMD, vigintile)) + 
  facet_wrap(~ la_name_IMD, strip.position = 'bottom', scales = 'free_x', ncol = 16) +
  ggtitle("Deprivation Profiles") + 
  geom_violin(aes(weight = count), linetype = 0, fill = '#000000', adjust = 0.4) +
  theme(legend.position = 'none',
        plot.subtitle = element_text(color = '#b1b1b1', size = 18, face='italic'),
        plot.title = element_text(color = "#000000", size = 36),
        strip.background = element_rect(fill = '#ffffff'),
        strip.text = element_text(color = '#000000', size = 8),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title = element_text(color = "#000000", size = 12),
        plot.background = element_rect(fill = "#ffffff"),
        panel.background = element_rect(fill = "#ffffff"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

eng_imd_lava

ggsave("~/Desktop/Lavalamps 2025/deprivation_lava_lamps_2025.png", eng_imd_lava, width = 40, height = 60, units = "cm", dpi = 300)
ggsave("~/Desktop/Lavalamps 2025/deprivation_lava_lamps_2025.svg", eng_imd_lava, width = 40, height = 60, units = "cm")
